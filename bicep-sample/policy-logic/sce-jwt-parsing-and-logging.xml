<!--
    Policy Fragment: sce-jwt-parsing-and-logging
    Purpose: Extracts JWT claims from Authorization header and sets them as headers for native APIM logging
    Usage: <include-fragment fragment-id="sce-jwt-parsing-and-logging" />
    Configure "Headers to log" in APIM Diagnostic Settings: X-JWT-ClientID, X-JWT-TenantID, X-JWT-Audience, X-JWT-Status
-->
<fragment>
	<!-- 
        STEP 1: Parse JWT and extract claims into a reusable variable
        Returns a JObject with four properties: ClientID, TenantID, Audience, Status
    -->
	<set-variable name="jwt-claims" value="@{
        // Initialize with default values for missing/invalid auth scenarios
        var result = new JObject(
            new JProperty("ClientID", "00000000-0000-0000-0000-000000000000"),
            new JProperty("TenantID", "00000000-0000-0000-0000-000000000000"),
            new JProperty("Audience", "NO_AUTH_HEADER"),
            new JProperty("Status", "NO_AUTH_HEADER")
        );
        
        // CASE 1: No Authorization header present - return defaults
        string authHeader = context.Request.Headers.GetValueOrDefault("Authorization", "");
        if (string.IsNullOrWhiteSpace(authHeader)) {
            return result;
        }
        
        // CASE 2: Authorization header exists but isn't valid "Bearer <token>" format
        string[] parts = authHeader.Split(' ');
        if (parts.Length != 2 || !parts[0].Equals("Bearer", StringComparison.OrdinalIgnoreCase))
        {
            result["Audience"] = "ERROR";
            result["Status"] = "INVALID_FORMAT";
            return result;
        }
        
        // CASE 3: Valid Bearer token format - attempt to parse JWT
        try
        {
            Jwt jwt = parts[1].AsJwt();
            
            // CASE 3a: Token couldn't be parsed as JWT
            if (jwt?.Claims == null)
            {
                result["Audience"] = "ERROR";
                result["Status"] = "PARSE_FAILED";
                return result;
            }
            
            // CASE 3b: Valid JWT - extract claims (appid, tid, aud)
            string[] v;
            if (jwt.Claims.TryGetValue("appid", out v) && v?.Length > 0 && !string.IsNullOrEmpty(v[0]))
            {
                result["ClientID"] = v[0];
            }
            if (jwt.Claims.TryGetValue("tid", out v) && v?.Length > 0 && !string.IsNullOrEmpty(v[0]))
            {
                result["TenantID"] = v[0];
            }
            if (jwt.Claims.TryGetValue("aud", out v) && v?.Length > 0 && !string.IsNullOrEmpty(v[0]))
            {
                result["Audience"] = v[0];
            }
            
            // Set final status based on whether all required claims were found
            if (result["ClientID"].ToString() != "00000000-0000-0000-0000-000000000000" &&
                result["TenantID"].ToString() != "00000000-0000-0000-0000-000000000000" &&
                result["Audience"].ToString() != "NO_AUTH_HEADER")
            {
                result["Status"] = "OK";
            }
            else
            {
                result["Status"] = "MISSING_CLAIMS";
            }
        }
        catch 
        { 
            // CASE 3c: Unexpected error during parsing
            result["Audience"] = "ERROR"; 
            result["Status"] = "PARSE_FAILED"; 
        }
        
        return result;
    }" />
	<!-- 
        STEP 2: Set headers from parsed claims
        These headers are captured by APIM's "Headers to log" diagnostic setting
        and appear as dedicated columns in Log Analytics (ApiManagementGatewayLogs)
    -->
	<set-header name="X-JWT-ClientID" exists-action="override">
		<value>@(((JObject)context.Variables["jwt-claims"])["ClientID"].ToString())</value>
	</set-header>
	<set-header name="X-JWT-TenantID" exists-action="override">
		<value>@(((JObject)context.Variables["jwt-claims"])["TenantID"].ToString())</value>
	</set-header>
	<set-header name="X-JWT-Audience" exists-action="override">
		<value>@(((JObject)context.Variables["jwt-claims"])["Audience"].ToString())</value>
	</set-header>
	<set-header name="X-JWT-Status" exists-action="override">
		<value>@(((JObject)context.Variables["jwt-claims"])["Status"].ToString())</value>
	</set-header>
</fragment>